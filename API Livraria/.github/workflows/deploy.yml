# Nome do workflow que aparecerá na aba "Actions" do GitHub
name: Deploy API Livraria para Homelab

# Gatilho: Este workflow será executado a cada push na branch 'master'
on:
  push:
    branches: [ "master" ]

# Define os trabalhos a serem executados
jobs:
  build-and-deploy:
    # Nome do job
    name: Compilar e Fazer Deploy
    
    # Instrução crucial: diz para usar o seu runner no homelab
    runs-on: self-hosted

    # Passos que o runner irá executar em sequência
    steps:
    # Passo 1: Baixa a versão mais recente do seu código do GitHub para o runner
    - name: Checkout do código
      uses: actions/checkout@v4

    # Passo 2: Restaura as dependências do projeto (pacotes NuGet)
    - name: Restaurar dependências .NET
      run: dotnet restore "./ApiLivraria/ApiLivraria.csproj"

    # Passo 3: Compila e "publica" a API, criando uma pasta com os arquivos prontos para deploy
    - name: Publicar aplicação .NET
      run: dotnet publish "./ApiLivraria/ApiLivraria.csproj" --configuration Release --output ./publish

    # Passo 4: Executa os comandos de deploy no servidor
    - name: Fazer Deploy no Servidor
      run: |
        echo "--> Parando o serviço da API Livraria..."
        sudo systemctl stop apilivraria.service
        
        echo "--> Limpando o diretório de deploy antigo..."
        sudo rm -rf /var/www/apilivraria/*
        
        echo "--> Copiando os novos arquivos da API..."
        sudo cp -a ./publish/. /var/www/apilivraria/
        
        echo "--> Iniciando o serviço da API Livraria..."
        sudo systemctl start apilivraria.service
        
        echo "--> Deploy da API Livraria concluído com sucesso!"